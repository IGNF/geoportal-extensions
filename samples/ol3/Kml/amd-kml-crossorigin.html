<!DOCTYPE html>
<html>
<head>
  <meta content="IE=edge,chrome=1; charset=UTF-8" http-equiv="X-UA-Compatible">
  <title>sample ol3 KML crossOrigin</title>

  <!-- Library OpenLayers 3 -->
  <link rel="stylesheet" href="../../../lib/ol3/ol.css" />
  <!-- <script src="../../../lib/ol3/ol-debug.js"></script> -->

  <!-- Plugin OpenLayers 3 IGN -->
  <link rel="stylesheet" href="../../../dist/ol3/GpPluginOl3.css" />
  <!-- <script src="../../../dist/ol3/GpPluginOl3.js" data-url="./../resources/AutoConf.js"></script> -->

  <!-- requirejs -->
  <script src="../../../lib/require.js"></script>

  <!-- load geoportail-waiting image -->
  <style>
  div#map {
    background-image:url(../resources/geoportail-waiting.gif);
    background-position:center center;
    background-repeat:no-repeat;
    max-width: 800px;
    height: 300px;
    margin: 10px;
  }
  </style>

</head>
<body>
  <h1>
    <a href="http://openlayers.org/"><img src="../resources/logo-ol3.png" alt="OpenLayers3" width="100" /></a>
    <a href="http://www.ign.fr"><img src="../resources/logo-ign.jpg" alt="IGN" width="100" /></a>
  </h1>
  <h3>
    OpenLayers3 - A high-performance, feature-packed library for all your mapping needs.
  </h3>

  <div>
    <p>...</p>

    <script>

    var map;
    var vectorLayer;
    var vectorSource;
    var FormatChoice, kmlChoice;
    var kmlStringOut, kmlStringIn;
    var kmlProj;
    var cors;

    /* global requirejs */
    requirejs.config({
      "baseUrl" : "../../../src/",
      "paths": {
        // lib external
        // "ol" : "../lib/ol3/v3.18.1/ol-debug",
        // "ol" : "../lib/ol3/v3.20.1/ol-debug",
        "ol" : "../lib/ol3/ol-debug",
        "proj4"   : "../lib/proj4/proj4",
        "gp"      : "../lib/gp/GpServices-src",
        "sortable" : "../lib/sortable/Sortable",
        "woodman" : "../lib/woodman/woodman-amd"
      }
    });

    requirejs([
      "ol",
      "Ol3/Formats/KML",
      // "../samples/ol3/Kml/overload/__StyleIconOverload"
    ],
    function (ol, KMLExtended) {

      kmlStringIn = "<kml \
      xmlns=\"http://www.opengis.net/kml/2.2\" \
      xmlns:gx=\"http://www.google.com/kml/ext/2.2\" \
      xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \
      xsi:schemaLocation=\"http://www.opengis.net/kml/2.2 https://developers.google.com/kml/schema/kml22gx.xsd\">\
      <Document>\
      <Style id=\"waypoint\">\
      <IconStyle>\
      <Icon>\
      <href>http://zoom-guadeloupe.fr/Randos/icon_wp.png</href>\
      </Icon>\
      </IconStyle>\
      </Style>\
      <name>Waypoints</name>\
      <Placemark>\
      <name>Panneau d'informations</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/10-DSC06769M.jpg\" width=240 height=180> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.67135,16.01125,0</coordinates></Point>\
      </Placemark>\
      <Placemark>\
      <name>Gommier blanc</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/21-DSC06796M.jpg\" width=180 height=240> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.66906,16.01388,0</coordinates></Point>\
      </Placemark>\
      <Placemark>\
      <name>Le Bassin Bleu</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/41-IMG_2850M.jpg\" width=240 height=180> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.66616,16.01820,0</coordinates></Point>\
      </Placemark>\
      <Placemark>\
      <name>Les Carbets</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/35-DSC06859M.jpg\" width=240 height=180> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.66650,16.01696,0</coordinates></Point>\
      </Placemark>\
      <Placemark>\
      <name>Cascade de Ravine Chaude</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/75-IMG_1751M.jpg\" width=180 height=240> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.66548,16.01937,0</coordinates></Point>\
      </Placemark>\
      <Placemark>\
      <name>Fougère Arborescentes</name>\
      <description><![CDATA[<img src=\"http://zoom-guadeloupe.fr/images/stories/Randos/BasseTerre/BassinBleu/Paysages/24-DSC06811M.jpg\" width=180 height=240> ]]></description>\
      <styleUrl>#waypoint</styleUrl>\
      <Point><coordinates>-61.66768,16.01412,0</coordinates></Point>\
      </Placemark>\
      </Document>\
      </kml>";

      // layer
      var rasterLayer = new ol.layer.Tile({
        source: new ol.source.TileJSON({
          url: 'https://api.tiles.mapbox.com/v3/mapbox.geography-class.json?secure',
          crossOrigin: 'anonymous'
        })
      });

      // map
      map = new ol.Map({
        target: 'map',
        layers: [
          rasterLayer
        ],
        view: new ol.View({
          projection : "EPSG:4326",
          center: [-61.6,16.2],
          zoom: 10
        })
      });

      var addKMLToMap = function (features) {

        if (vectorLayer) {
          map.removeLayer(vectorLayer);
        }

        // add KML into the map
        vectorSource =  new ol.source.Vector({
            features : features
        });

        vectorLayer = new ol.layer.Vector({
          source : vectorSource
        });

        map.addLayer(vectorLayer);
      };

      document.getElementById("loadKml").onclick = function (e) {

        if (!FormatChoice) {
          FormatChoice = ol.format.KML;
        }

        // read KML string
        var format = new FormatChoice ({ // ol.format.KML
          cors : cors,
          showPointNames : true
        });
        kmlProj = format.readProjection(kmlStringIn);
        var mapProj = map.getView().getProjection().getCode();
        var features = format.readFeatures(
          kmlStringIn,
          {
            dataProjection : kmlProj,
            featureProjection : mapProj
          }
        );

        console.log(features);

        addKMLToMap(features);
      };

      document.getElementById("writeKml").onclick = function (e) {

        // write KML string
        var format = new FormatChoice ({ // ol.format.KML
          writeStyles : true
        });

        kmlStringOut = format.writeFeatures(
          vectorLayer.getSource().getFeatures(), {
            dataProjection : kmlProj,
            featureProjection : "EPSG:3857"
          }
        );

        console.log(kmlStringOut);
      };

      document.getElementById("readKml").onclick = function (e) {

        // read KML string
        var format = new FormatChoice ({ // ol.format.KML
          showPointNames : true
        });

        var features = format.readFeatures(
          kmlStringOut,
          {
            dataProjection : kmlProj,
            featureProjection : "EPSG:3857"
          }
        );

        addKMLToMap(features);

      };

      // get list of radio buttons with name 'size'
      var formats = document.getElementsByName("format");

      // loop through list
      for (var i=0, len=formats.length; i<len; i++) {
        formats[i].onclick = function(e) {
          var currentValue = e.target.value;
          switch (currentValue) {
            case "form1":
               FormatChoice = ol.format.KML;
              break;
            case "form2":
                FormatChoice = KMLExtended;
              break;
            default:
              FormatChoice = KMLExtended;
          }
        };
      }

      // get list of radio buttons with name 'size'
      var corsDiv = document.getElementsByName("cors");

      // loop through list
      for (var i=0, len=corsDiv.length; i<len; i++) {
        corsDiv[i].onclick = function(e) {
          var currentValue = e.target.value;
          switch (currentValue) {
            case "true":
              cors = true;
              break;
            case "false":
              cors = false;
              break;
            default:
              cors = false;
          }
      };
    }

    function handleClickKmlChoice (myRadio) {
        var currentValue = myRadio.value;
        switch (currentValue) {
          case "form1":
             kmlChoice = kmlStringIn1;
            break;
          case "form2":
              kmlChoice = kmlStringIn2;
            break;
          case "form3":
              kmlChoice = kmlStringIn3;
            break;
          case "form4":
              kmlChoice = kmlStringIn4;
            break;
          case "form5":
              kmlChoice = kmlStringIn5;
            break;
          case "form6":
                kmlChoice = kmlStringIn6;
              break;
          default:
            kmlChoice = kmlStringIn1;
        }
    }

  });

    </script>

    <!-- map -->
    <div id="map">
    </div>
    <input type="radio" name="format" value="form1" checked> Format KML<br>
    <input type="radio" name="format" value="form2"> Format KMLExtended<br>
    <hr width="50%" align="left">
    ￼<input type="radio" name="cors" value="false" checked> cors:false<br>
    <input type="radio" name="cors" value="true"> cors:true<br>
    <hr width="50%" align="left">
    <input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form1" checked> Form : Label étendu avec point <br>
    <!-- input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form2"> Form : Label étendu avec point (extendData)<br>
    <input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form3"> Form : Label normal avec un point<br>
    <input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form4"> Form : Label étendu<br>
    <input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form5"> Form : Label normal avec style<br>
    <input type="radio" name="kml" onclick="handleClickKmlChoice(this);" value="form6"> Form : Label sans style (par defaut)<br -->
    <hr width="50%" align="left">
    <button type="button" id="loadKml">Load KML</button> -->
    <button type="button" id="writeKml">Write KML</button> -->
    <button type="button" id="readKml">Reload KML</button>


    <!-- Comment utiliser le plugin avec un exemple -->
    <p>EXEMPLE D'UTILISATION</p>
    <pre>
      <code>
        window.onload = function () {}
      </code>
    </pre>

    <!-- Toutes les informations utiles sur ol3 -->
    <p>
      <ul>
        <li>En savoir plus avec le <a href="http://openlayers.org/en/v3.11.2/doc/quickstart.html">quick start guide</a>,</li>
        <li>d'autres informations avec <a href="http://openlayers.org/en/v3.11.2/examples/">les exemples</a>,</li>
        <li>ou aller directement à l'<a href="http://openlayers.org/en/v3.11.2/apidoc/">API documentation</a>.</li>
      </ul>
      Si vous avez des questions, jetez un oeil à la
      <a href="http://stackoverflow.com/questions/tagged/openlayers-3">FAQ</a>.
    </p>
  </div>
</body>
</html>
