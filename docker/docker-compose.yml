version: "3.7"

services:
  extensions:
    build:
      context: ..
      dockerfile: ./docker/Dockerfile
    image: extensions
    container_name: extensions-server
    depends_on: 
      - access-lib
    expose:
      - 9021
    ports:
      - 9021:9021
    volumes:
      - extensions-data-ext-volume:/home/docker/html/geoportal-extensions
      - extensions-data-acc-volume:/home/docker/html/geoportal-access-lib
      - ${EXTENSIONS}/src:/home/docker/geoportal-extensions/src
      - ${EXTENSIONS}/test:/home/docker/geoportal-extensions/test
      - ${EXTENSIONS}/test_rendering:/home/docker/geoportal-extensions/test_rendering
      - ${EXTENSIONS}/samples-src:/home/docker/geoportal-extensions/samples-src
    networks:
      - api-network

  access-lib:
    build:
      context: ${ACCESSLIB}
      dockerfile: ./docker/Dockerfile
    image: access-lib
    container_name: access-lib-server
    expose:
      - 9012
      - 9013
    ports:
      - 9012:9012
      - 9013:9013
    volumes:
      - extensions-data-acc-volume:/home/docker/html/geoportal-access-lib
      - ${ACCESSLIB}/src:/home/docker/geoportal-access-lib/src
      - ${ACCESSLIB}/test:/home/docker/geoportal-access-lib/test
      - ${ACCESSLIB}/samples-src:/home/docker/geoportal-access-lib/samples-src
    networks:
      - api-network
    
  
  nginx:
    image: nginx:1.17.9
    container_name: nginx-server
    command: nginx-debug -g 'daemon off;'
    depends_on: 
      - access-lib
      - extensions
    ports:
      - 8081:80
    volumes:
      - ./conf/default:/etc/nginx/sites-enabled/default:ro
      - ./conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - extensions-data-ext-volume:/var/www/html/geoportal-extensions
      - extensions-data-acc-volume:/var/www/html/geoportal-access-lib
    networks:
      - api-network

volumes:
  extensions-data-ext-volume:
    name: extensions-data-ext-volume
  extensions-data-acc-volume:
    name: extensions-data-acc-volume

networks:
  api-network:
    name: api-network
    driver: bridge
    ipam:
      driver: default