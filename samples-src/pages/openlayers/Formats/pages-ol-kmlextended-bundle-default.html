{{#extend "ol-sample-bundle-layout"}}

{{#content "head"}}
        <title>Sample openlayers</title>
        <script src="https://unpkg.com/ol-popup@3.0.0"></script>
        <link rel="stylesheet" href="https://unpkg.com/ol-popup@3.0.0/src/ol-popup.css" />
{{/content}}

{{#content "style"}}
        <style>
            div#map {
                width: 100%;
                height: 500px;
            }
            #viewer {
                width: 100%;
            }
        </style>
{{/content}}

{{#content "body"}}
            <h2>Ajout d'une couche KML</h2>
            <!-- map -->
            <div id="map">
            </div>
            <!-- export -->
            <button id="export" title="Exporter la couche de dessin">Exporter</button>
            <button id="view" title="Afficher les métadonnées de la couche de calcul">Afficher</button>
            <div>
                <textarea id="viewer" rows="10" cols="50"></textarea>
            </div>
{{/content}}

{{#content "js"}}
            <script type="text/javascript">
                var map;
                var sampleLayer;
                var exportLayer;
                var exportFormat;
                window.onload = function() {
                    // on cache l'image de chargement du Géoportail.
                    document.getElementById('map').style.backgroundImage = 'none';

                    var sampleUrl = location.href.substring(0, location.href.lastIndexOf('/')) + "/../../resources/data/kml/croquis-extendeddata.kml";
                    sampleLayer = new ol.layer.Vector({
                        source : new ol.source.Vector({
                            url: sampleUrl,
                            format: new ol.format.KMLExtended()
                        })
                    });

                    exportFormat = new ol.format.KMLExtended();
                    var exportUrl = location.href.substring(0, location.href.lastIndexOf('/')) + "/../../resources/data/kml/export-route.kml";
                    var exportLayer = new ol.layer.Vector({
                        source : new ol.source.Vector({
                            url: exportUrl,
                            format: exportFormat
                        })
                    });

                    map = new ol.Map({
                        target : "map",
                        view : new ol.View({
                            center : [0,0],
                            zoom : 2
                        }),
                        layers : [
                            new ol.layer.GeoportalWMS({
                                layer : "ORTHOIMAGERY.ORTHOPHOTOS"
                            }),
                            sampleLayer,
                            exportLayer
                        ]
                    });

                    var layerSwitcher = new ol.control.LayerSwitcher({
                        layers : [
                            {
                                layer : sampleLayer,
                                config : {
                                    title : "Couche de dessin à exporter"
                                }
                            },
                            {
                                layer : exportLayer,
                                config : {
                                    title : "Calcul d'itineraire"
                                }
                            }
                        ]
                    });
                    map.addControl(layerSwitcher);

                    var popup = new ol.Overlay.Popup();
                    map.addOverlay(popup);

                    // cf. http://astuntechnology.github.io/osgis-openlayers-leaflet/openlayers/03-GEOJSON-INFO.html
                    map.on("click", function(evt) {

                        popup.hide();
                        popup.setOffset([0, 0]);

                        // Attempt to find a feature in one of the visible vector layers
                        var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                            return feature;
                        });

                        if (feature) {

                            var coord = evt.coordinate;
                            var props = feature.getProperties();
                            var contents = "";
                            for (var key in props) {
                                if (props.hasOwnProperty(key)) {
                                    contents += key + " / " + props[key];
                                    contents += "<br>";
                                }
                            }
                            // Offset the popup so it points at the middle of the marker not the tip
                            popup.setOffset([0, -22]);
                            popup.show(coord, contents);

                        }
                    });
                };
                document.getElementById("export").addEventListener("click", function () {
                    var result = null;
                    if (!sampleLayer) {
                        console.log("Impossible to export : no layer is hosting features.");
                        return result;
                    }
                    if (!sampleLayer.getSource() ||
                        !sampleLayer.getSource().getFeatures() ||
                        !sampleLayer.getSource().getFeatures().length) {
                        console.log("Impossible to export : no features found.");
                        return result;
                    }
                    var kml = new ol.format.KMLExtended({
                        writeStyles : true,
                        extensions : {
                            root : {
                                typestring : "string",
                                typenumber : 22,
                                typefloat : 1.22,
                                typeobject : {
                                    typestringone : "string1",
                                    typestringtwo : null
                                },
                                typearray : ["item1", "item2"],
                                typearrayofobject : [
                                    {
                                        typestringone : "string1",
                                                typestringtwo : null
                                    },
                                    {
                                        typestringone : "string1",
                                        typestringtwo : "string2"
                                    },
                                ],
                                typearrayofarray : [
                                    [1, 2], null, [1, 3], null, [1, 4]
                                ]
                            }
                        }
                    });

                    result = kml.writeFeatures(sampleLayer.getSource().getFeatures(), {
                        dataProjection : "EPSG:4326",
                        featureProjection : sampleLayer.getSource().getProjection()
                    });

                    document.getElementById("viewer").textContent = result;

                    var link = document.createElement("a");
                    var charset = "utf-8";
                    link.setAttribute("href", "data:application/vnd.google-earth.kml+xml;charset=" + charset + "," + encodeURIComponent(result));
                    link.setAttribute("download", "sample.kml");
                    link.click();
                });
                document.getElementById("view").addEventListener("click", function () {
                    var key = "geoportail:compute";
                    var result = exportFormat.readRootExtensions(key);
                    var contents = "";
                    var length = "30";
                    for (var key in result) {
                        if (result.hasOwnProperty(key)) {
                            var value = result[key];
                            if (typeof value === "string") {
                                value = result[key].substring(0, length);
                            }
                            contents += "* " + key + " : " + value;
                            contents += "\n";
                        }
                    }
                    document.getElementById("viewer").textContent = contents;
                });
            </script>
{{/content}}

{{/extend}}
